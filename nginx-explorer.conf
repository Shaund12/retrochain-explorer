# RetroChain Explorer Nginx Configuration
# Place this in /etc/nginx/sites-available/retrochain-explorer

server {
  listen 80;
  listen [::]:80;
  server_name retrochain.ddns.net;
  return 301 https://$host$request_uri;
}

server {
  listen 443 ssl;
  listen [::]:443 ssl;
  http2 on;

  server_name retrochain.ddns.net;

  ssl_certificate /etc/letsencrypt/live/retrochain.ddns.net/fullchain.pem;
  ssl_certificate_key /etc/letsencrypt/live/retrochain.ddns.net/privkey.pem;

  ssl_protocols TLSv1.2 TLSv1.3;
  ssl_prefer_server_ciphers on;

  client_max_body_size 20m;

  add_header X-Content-Type-Options "nosniff" always;
  add_header X-Frame-Options "SAMEORIGIN" always;
  add_header Referrer-Policy "strict-origin-when-cross-origin" always;
  add_header Permissions-Policy "geolocation=(), microphone=(), camera=()" always;
  add_header Strict-Transport-Security "max-age=31536000; includeSubDomains" always;

  gzip on;
  gzip_vary on;
  gzip_proxied any;
  gzip_comp_level 5;
  gzip_types
    text/plain text/css text/javascript application/javascript application/json
    application/xml application/rss+xml image/svg+xml;

  location = /healthz {
    default_type text/plain;
    return 200 "ok\n";
  }

  location = /favicon.ico { access_log off; log_not_found off; }
  location = /robots.txt  { access_log off; log_not_found off; }

  # ============================
  # Explorer UI (STATIC)
  # ============================
  location ^~ /assets/ {
    root /var/www/retrochain-explorer;
    access_log off;
    expires 30d;
    add_header Cache-Control "public, max-age=2592000, immutable";
    try_files $uri =404;
  }

  # ============================
  # Explorer-hosted Swagger spec (STATIC) - FIX
  # ============================
  location = /api-docs {
    return 302 /api-docs/;
  }

  location ^~ /api-docs/ {
    alias /var/www/retrochain-explorer/api-docs/;
    try_files $uri =404;
    default_type text/yaml;
  }

  # Optional: support /swagger/* if anything still links there
  location ^~ /swagger/ {
    alias /var/www/retrochain-explorer/api-docs/;
    try_files $uri =404;
    default_type text/yaml;
  }

  # ============================
  # Arcade SPA vs embedded game assets
  # ============================
  # Ensure the dashboard route /arcade renders the Vue SPA (avoids static dir collision)
  location = /arcade {
    root /var/www/retrochain-explorer;
    try_files /index.html =404;
  }

  # Keep the embedded Space Invaders bundle working under /arcade/arcade/
  location ^~ /arcade/arcade/ {
    alias /var/www/retrochain-explorer/arcade/arcade/;
    try_files $uri $uri/ =404;
  }

  # Slots SPA fallback (avoid 403 on direct refresh)
  location = /slots {
    root /var/www/retrochain-explorer;
    try_files /index.html =404;
  }

  # If any static bundle is served under /slots/slots/, keep it accessible
  location ^~ /slots/slots/ {
    alias /var/www/retrochain-explorer/slots/slots/;
    try_files $uri $uri/ =404;
  }

  # SPA fallback
  location / {
    root /var/www/retrochain-explorer;
    try_files $uri $uri/ /index.html;
  }

  # ============================
  # Cosmos Hub RPC proxy (browser-friendly CORS)
  # ============================
  location /cosmos-rpc/ {
    if ($request_method = OPTIONS) {
      add_header 'Access-Control-Allow-Origin' '*' always;
      add_header 'Access-Control-Allow-Methods' 'GET, POST, OPTIONS' always;
      add_header 'Access-Control-Allow-Headers' 'Origin, Content-Type, Accept, Authorization' always;
      add_header 'Access-Control-Max-Age' 86400;
      return 204;
    }

    proxy_pass https://rpc.cosmos.network/;
    proxy_http_version 1.1;

    proxy_set_header Host rpc.cosmos.network;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto https;

    proxy_ssl_server_name on;
    proxy_ssl_name rpc.cosmos.network;

    proxy_connect_timeout 10s;
    proxy_read_timeout 60s;
    proxy_send_timeout 60s;

    add_header 'Access-Control-Allow-Origin' '*' always;
    add_header 'Access-Control-Allow-Methods' 'GET, POST, OPTIONS' always;
    add_header 'Access-Control-Allow-Headers' 'Origin, Content-Type, Accept, Authorization' always;
  }

  # ============================
  # REST API (all Cosmos + all custom modules)
  # ============================
  location = /api/unconfirmed_txs {
    proxy_pass http://127.0.0.1:26657/unconfirmed_txs;
    proxy_http_version 1.1;

    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto https;
  }

  # NOTE: trailing slash strips /api/ prefix before proxying.
  location ^~ /api/ {
    proxy_pass http://127.0.0.1:1317/;
    proxy_http_version 1.1;

    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto https;
  }

  location = /api/cosmos/burn/v1beta1/params {
    default_type application/json;
    return 200 '{"params":{"burn_enabled":false,"additional_notes":"stubbed by nginx"}}';
  }

  # ============================
  # CometBFT RPC
  # ============================
  location = /rpc/ {
    proxy_pass http://127.0.0.1:26657/status;
    proxy_http_version 1.1;

    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto https;
  }

  location ^~ /rpc/ {
    proxy_pass http://127.0.0.1:26657/;
    proxy_http_version 1.1;

    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto https;
  }

  # ============================
  # CometBFT WebSocket
  # ============================
  location = /websocket {
    proxy_pass http://127.0.0.1:26657/websocket;
    proxy_http_version 1.1;

    proxy_read_timeout 3600s;
    proxy_send_timeout 3600s;

    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection "upgrade";
    proxy_set_header Host $host;

    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto https;

    proxy_set_header X-Forwarded-Host $host;
    proxy_set_header X-Forwarded-Port $server_port;

    proxy_buffering off;
  }

  location = /ws/ {
    proxy_pass http://127.0.0.1:26657/websocket;
    proxy_http_version 1.1;

    proxy_read_timeout 3600s;
    proxy_send_timeout 3600s;

    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection "upgrade";
    proxy_set_header Host $host;

    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto https;

    proxy_set_header X-Forwarded-Host $host;
    proxy_set_header X-Forwarded-Port $server_port;

    proxy_buffering off;
  }

  # ============================
  # Umami analytics (REMOVED)
  # ============================
}
